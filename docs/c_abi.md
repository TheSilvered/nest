# C ABI reference

## Nomenclature

All functions and global variables start with the prefix `nst_` and use snake
case. Functions that are prefixed with `_nst_` are used internally and should
not be used in outside programs. An exception are the functions that have a
wrapper that implicitly casts the arguments to the correct types.

All structs and enums are redefined as a type that start with the prefix `Nst_`
and use pascal case. To use the original struct the prefix is `_Nst_`. For
example `Nst_OpErr` and `struct _Nst_OpErr` are equivalent.

Most macros start with the prefix `NST_` and use uppercase snake case. Macros
that start with `_NST_`, like functions, are used internally and should not be
used.  
The macros that do not start with these prefixes are `OBJ`, `GGC_OBJ`, `AS_INT`,
`AS_REAL`, `AS_BYTE`, `AS_BOOL`, `STR`, `VECTOR`, `ARRAY`, `SEQ`, `ITER`,
`IOFILE`, `FUNC` and `MAP` which simply cast a type of object to another. The
ones beginning with `AS_` also extract the value, this means that
`AS_INT(num_obj)` will cast `num_obj` to a `Nst_Int`, not a `Nst_IntObj *`.  
The macros used as include guards also do not start with `NST_`.  
There are other macros that start with `nst_` and these implicitly cast the
arguments of a function to the correct type, for example if `map` is of type
`Nst_Obj *` and `key` of type `Nst_StrObj *` you would have to write
`_nst_map_get(MAP(map), OBJ(key))` but with the macro you can just call the
function: `nst_map_get(map, key)`.

## Type definitions

Instead of using standard C types, the file `typedefs.h` defines some clearer
types inspired by Rust:

| Type name | C Equivalent           |
| --------- | ---------------------- |
| i8        | char                   |
| u8        | unsigned char          |
| i16       | short                  |
| u16       | unsigned short         |
| i32       | long int               |
| u32       | unsigend long int      |
| i64       | long long int          |
| i64       | unsigned long long int |
| f32       | float                  |
| f64       | double                 |
| usize     | size_t                 |
| isize     | ptrdiff_t              |


## `argv_parser.h`

### `nst_parse_args`

**Synopsis**:

```better-c
i32 _nst_parse_args(i32 argc, i8 **argv,
                    bool *print_tokens,
                    bool *print_ast,
                    bool *print_bytecode,
                    bool *force_execution,
                    bool *monochrome,
                    bool *force_cp1252,
                    bool *no_default,
                    i32  *opt_level,
                    i8  **command,
                    i8  **filename,
                    i32  *args_start)
```

**Description**:

Parses the command-line arguments given to the program.

**Arguments**:

- `[in] argc` the number of arguments
- `[in] argv` the array of the arguments
- `[out] print_tokens` the `-t` or `--tokens` option
- `[out] print_ast` the `-a` or `--ast` option
- `[out] print_bytecode` the `-b` or `--bytecode` option
- `[out] force_execution` the `-f` or `--force-execution` option
- `[out] monochrome` the `-m` option
- `[out] force_cp1252` the `--cp1252` option
- `[out] no_default` the `--no-default` option
- `[out] opt_level` the `-O<lvl>` option
- `[out] command` the value after `-c`
- `[out] filename` the file name passed
- `[out] args_start` the index at which the arguments in `_args_` begin

**Return value**:

- `-1` is returned if the parsing failed
- `0` is returned if the parsing succeded and the program can run
- `1` is returned if the parsing succeded and the program should stop because a
  message was printed.

---

## `compiler.h`

### `nst_compile`

**Synopsis**:

```better-c
Nst_InstList *nst_compile(Nst_Node *ast, bool is_module, Nst_Error *error)
```

**Description**:

Compiles the AST into bytecode.

**Arguments**:

- `[in] ast` the root node of the AST
- `[in] is_module` whether to compile the AST as a module or as the main program
- `[out] error` the possible error that occurred during the compilation

**Return value**:

Returns the instruction list generated by the compiler or `NULL` or failure.

---

### `nst_print_bytecode`

**Synopsis**:

```better-c
void nst_print_bytecode(Nst_InstList *ls, i32 indent)
```

**Description**:

Prints the bytecode to the standard output.

**Arguments**:

- `[in] ls` the bytecode to print
- `[in] indent` the indentation level of the bytecode, use `0` to print it
  normally

---

## `encoding.h`

### `nst_check_utf8_bytes`

**Synopsis**:

```better-c
i32 nst_check_utf8_bytes(u8 *byte, usize len)
```

**Description**:

Checks that the first character of `byte` is encoded in UTF-8, this means that
for multi-byte characters more than one byte is checked.

**Arguments**:

- `[in] byte` the bytes to check
- `[in] len` the size of `byte` in bytes

**Return value**:

The return value is the number of bytes that make up the caracter or `-1` if an
invalid sequence is detected.

```better-c
// Check if a string is encoded in UTF-8
// string is of type Nst_StrObj *

i8 *value = string->value;
usize len = string->len;
bool is_valid = true;

for ( int i = 0; i < len; )
{
    int char_size = nst_check_utf8_bytes(value + i, len - i);
    if ( char_size == -1 )
    {
        is_valid = false;
        break;
    }
    i += char_size;
}
```

---

### `nst_cp1252_to_utf8`

**Synopsis**:

```better-c
i32 nst_cp1252_to_utf8(i8 *str, i8 byte)
```

**Description**:

Converts a byte encoded in CP1252 to UTF-8.

**Arguments**:

- `[out] str` the buffer where the bytes will be written
- `[in] byte` the CP1252 byte to convert

**Return value**:

Returns the number of bytes written or `-1` if `byte` was not valid.

---

### `nst_check_utf16_bytes`

**Synopsis**:

```better-c
i32 nst_check_utf16_bytes(u16 *byte, usize len)
```

**Description**:

Checks that the first character of `byte` is encoded in UTF-16, this means that
for multi-byte characters more than one byte is checked.

**Arguments**:

- `[in] byte` the bytes to check
- `[in] len` the length of `byte`

**Return value**:

Returns the length of the character or `-1` if an invalid sequence is found.

---

### `nst_utf16_to_utf8`

**Synopsis**:

```better-c
i32 nst_utf16_to_utf8(i8 *out_str, u16 *in_str, usize in_str_len)
```

**Description**:

Converts a character encoded in UTF-16 to UTF-8.

**Arguments**:

- `[out] out_str` the buffer where the bytes will be written
- `[in] in_str` the character to convert
- `[in] in_str_len` the length of `in_str`

**Return value**:

Returns the number of bytes written or `-1` if an invalid sequence is detected.

---

## `error.h`

### `_NST_EM_*` macros

**Description**:

All the macros starting with `_NST_EM` are error messages used internally by the
interpreter.

---

### `Nst_SourceText`

**Synopsis**:

```better-c
typedef struct _Nst_SourceText
{
    i8 *text;
    i8 *path;
    i8 **lines;
    usize len;
    usize line_count;
}
Nst_SourceText;
```

**Description**:

A struct that holds the source text of a loaded file, that could be either the
main file or any modules imported afterwards.

**Fields**:

- `text` the text itself
- `path` the path of the file
- `lines` an array of pointers to the start of each line of the file
- `len` the length of `text`
- `line_count` the number of lines present in the file

---

### `Nst_Pos`

**Synopsis**:

```better-c
typedef struct _Nst_Pos
{
    i32 line;
    i32 col;
    Nst_SourceText *text;
}
Nst_Pos;
```

**Description**:

A struct that keeps a position inside a certain file.

**Fields**:

- `line` the line of the position, starts from `0`
- `col` the column of the position, also starts from `0`

---

### `Nst_Error`

**Synopsis**:

```better-c
typedef struct _Nst_Error
{
    bool occurred;
    Nst_Pos start;
    Nst_Pos end;
    Nst_StrObj *name;
    Nst_StrObj *message;
}
Nst_Error;
```

**Description**:

The internal struct for errors.

**Fields**:

- `occurred` whether the struct contains a valid error
- `start` the start position of the error
- `end` the end position of the error, inclusive
- `name` the name of the error
- `message` the message of the error

---

### `Nst_OpError`

**Synopsis**:

```better-c
typedef struct _Nst_OpErr
{
    Nst_StrObj *name;
    Nst_StrObj *message;
}
Nst_OpErr;
```

**Description**:

The error used by C functions.

**Fields**:

- `name` the name of the error
- `message` the message of the error

---

### `Nst_Traceback`

**Synopsis**:

```better-c
typedef struct _Nst_Traceback
{
    Nst_Error error;
    Nst_LList *positions;
}
Nst_Traceback;
```

**Description**:

The trace of positions that let to the error.

**Fields**:

- `error` the error that occurred
- `positions` the list of positions structured like \[start1, end1, start2,
  end2, ...]

---

### `nst_set_color`

**Synopsis**:

```better-c
void nst_set_color(bool color)
```

**Description**:

Sets whether the error output should be printed with ANSI color escapes.

**Arguments**:

- `[in] color` if set to `true`, color is used otherwise it is not

---

### `nst_copy_pos`

**Synopsis**:

```better-c
Nst_Pos nst_copy_pos(Nst_Pos pos)
```

**Description**:

Copies a position on the stack.

**Arguments**:

- `[in] pos` the position to be copied

**Return value**:

Returns the copied position.

---

### `nst_no_pos`

**Synopsis**:

```better-c
Nst_Pos nst_no_pos()
```

**Description**:

Creates an empty position.

**Return value**:

The position created.

---

### `nst_print_error`

**Synopsis**:

```better-c
void nst_print_error(Nst_Error err)
```

**Description**:

Prints an error to standard error formatting it and then frees it.

**Arguments**:

- `[in] err` the error to be printed

---

### `nst_print_traceback`

**Synopsis**:

```better-c
void nst_print_traceback(Nst_Traceback tb)
```

**Description**:

Prints an traceback to standard error formatting it and then frees it.

**Arguments**:

- `[in] tb` the traceback to be printed

---

### `nst_format_error`

**Synopsis**:

```better-c
Nst_StrObj *nst_format_error(const i8 *format, const i8 *format_args, ...)
```

**Description**:

Creates a new string object formatting it similarly to a printf string.

**Arguments**:

- `[in] format` the format string to use as a template for the final string, the
  only formats allowed are `%s`, `%zi` and `%lli`
- `[in] format_args` a string where each character symbolizes the type of the
  corresponding format.  
  `s` is used for `%s`  
  `u` is used for `%zi`  
  `i` is used for `%lli`

```better-c
// Here an error is thrown using nst_format_error, assuming that th type of
// `number` is Nst_Int
NST_SET_VALUE_ERROR(
  nst_format_error("Invalid number %lli", "i", number));
```

**Return value**:

Returns the generated string.

---

### `nst_free_src_text`

**Synopsis**:

```better-c
void nst_free_src_text(Nst_SourceText *text)
```

**Description**:

Frees a heap-allocated text source.

**Arguments**:

- `[in] text` the text to be freed
